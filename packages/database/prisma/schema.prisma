generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// PLAYERS & AUTH
// =============================================================================

model Player {
  id           String    @id @default(uuid())
  username     String    @unique @db.VarChar(32)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         String    @default("player") @db.VarChar(16)
  isBot        Boolean   @default(false) @map("is_bot")
  createdAt    DateTime  @default(now()) @map("created_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Character Progression
  characterXp     BigInt @default(0) @map("character_xp")
  characterLevel  Int    @default(1) @map("character_level")
  attributePoints Int    @default(0) @map("attribute_points")
  attributes      Json   @default("{\"vitality\":0,\"strength\":0,\"dexterity\":0,\"intelligence\":0,\"luck\":0,\"evasion\":0}")

  // HP System
  currentHp     Int      @default(100) @map("current_hp")
  lastHpRegenAt DateTime @default(now()) @map("last_hp_regen_at")
  isRecovering  Boolean  @default(false) @map("is_recovering")
  recoveryCost  Int?     @map("recovery_cost")

  // Auto-Potion
  autoPotionThreshold Int @default(0) @map("auto_potion_threshold")

  // Tutorial
  tutorialStep    Int      @default(0) @map("tutorial_step")

  // Preferences
  combatLogSpeedMs    Int     @default(800)  @map("combat_log_speed_ms")
  explorationSpeedMs  Int     @default(800)  @map("exploration_speed_ms")
  autoSkipKnownCombat Boolean @default(false) @map("auto_skip_known_combat")
  defaultExploreTurns Int     @default(100)  @map("default_explore_turns")
  quickRestHealPercent Int    @default(100)  @map("quick_rest_heal_percent")
  defaultRefiningMax  Boolean @default(false) @map("default_refining_max")

  // Zone / Travel
  currentZoneId          String? @map("current_zone_id")
  lastTravelledFromZoneId String? @map("last_travelled_from_zone_id")
  homeTownId             String? @map("home_town_id")

  currentZone            Zone?   @relation("current_zone", fields: [currentZoneId], references: [id])
  lastTravelledFromZone  Zone?   @relation("breadcrumb_zone", fields: [lastTravelledFromZoneId], references: [id])
  homeTown               Zone?   @relation("home_town", fields: [homeTownId], references: [id])

  // Active achievement title
  activeTitle        String?   @map("active_title")

  turnBank           TurnBank?
  skills             PlayerSkill[]
  equipment          PlayerEquipment[]
  items              Item[]
  bestiary           PlayerBestiary[]
  bestiaryPrefixes   PlayerBestiaryPrefix[]
  activityLogs       ActivityLog[]
  encounterSites     EncounterSite[]
  knownRecipes       PlayerRecipe[]
  refreshTokens      RefreshToken[]
  resourceNodes      PlayerResourceNode[]
  zoneDiscoveries    PlayerZoneDiscovery[]
  zoneExplorations   PlayerZoneExploration[]
  pvpRating          PvpRating?
  pvpAttacks         PvpMatch[] @relation("PvpAttacker")
  pvpDefenses        PvpMatch[] @relation("PvpDefender")
  bossParticipants   BossParticipant[]
  persistedMobs      PersistedMob[]
  stats              PlayerStats?
  achievements       PlayerAchievement[]

  @@map("players")
}

model RefreshToken {
  id        String   @id @default(uuid())
  playerId  String   @map("player_id")
  token     String   @unique @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// =============================================================================
// TURN ECONOMY
// =============================================================================

model TurnBank {
  playerId     String   @id @map("player_id")
  currentTurns Int      @default(86400) @map("current_turns")
  lastRegenAt  DateTime @default(now()) @map("last_regen_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("turn_banks")
}

// =============================================================================
// SKILLS
// =============================================================================

model PlayerSkill {
  id             String   @id @default(uuid())
  playerId       String   @map("player_id")
  skillType      String   @map("skill_type") @db.VarChar(32)
  level          Int      @default(1)
  xp             BigInt   @default(0)
  dailyXpGained  Int      @default(0) @map("daily_xp_gained")
  lastXpResetAt  DateTime @default(now()) @map("last_xp_reset_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, skillType])
  @@map("player_skills")
}

// =============================================================================
// EQUIPMENT
// =============================================================================

model PlayerEquipment {
  playerId String  @map("player_id")
  slot     String  @db.VarChar(16)
  itemId   String? @map("item_id")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  item   Item?  @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@id([playerId, slot])
  @@map("player_equipment")
}

// =============================================================================
// ITEMS
// =============================================================================

model ItemTemplate {
  id             String  @id @default(uuid())
  name           String  @db.VarChar(64)
  itemType       String  @map("item_type") @db.VarChar(32)
  weightClass    String? @map("weight_class") @db.VarChar(16)
  setId          String? @map("set_id") @db.VarChar(64)
  slot           String? @db.VarChar(16)
  tier           Int     @default(1)
  baseStats      Json    @default("{}") @map("base_stats")
  requiredSkill  String? @map("required_skill") @db.VarChar(32)
  requiredLevel  Int     @default(1) @map("required_level")
  maxDurability  Int     @default(100) @map("max_durability")
  stackable        Boolean @default(false)
  consumableEffect Json?   @map("consumable_effect")

  items           Item[]
  dropTables      DropTable[]
  chestDropTables ChestDropTable[]
  recipes         CraftingRecipe[]

  @@map("item_templates")
}

model Item {
  id                String   @id @default(uuid())
  templateId        String   @map("template_id")
  ownerId           String   @map("owner_id")
  rarity            String   @default("common") @db.VarChar(16)
  currentDurability Int?     @map("current_durability")
  maxDurability     Int?     @map("max_durability")
  quantity          Int      @default(1)
  bonusStats        Json?    @map("bonus_stats")
  createdAt         DateTime @default(now()) @map("created_at")

  template  ItemTemplate      @relation(fields: [templateId], references: [id])
  owner     Player            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  equipment PlayerEquipment[]

  @@map("items")
}

// =============================================================================
// ZONES
// =============================================================================

model Zone {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(64)
  description String? @db.Text
  difficulty  Int     @default(1)
  travelCost  Int     @map("travel_cost")
  isStarter   Boolean @default(false) @map("is_starter")
  zoneType       String  @default("wild") @map("zone_type") @db.VarChar(16) // wild | town
  zoneExitChance Float?  @map("zone_exit_chance")
  maxCraftingLevel Int?    @default(0) @map("max_crafting_level")
  turnsToExplore   Int?  @map("turns_to_explore")
  explorationTiers Json? @map("exploration_tiers")

  mobs               MobTemplate[]
  resourceNodes      ResourceNode[]
  zoneMobFamilies    ZoneMobFamily[]
  encounterSites     EncounterSite[]
  connectionsFrom    ZoneConnection[]        @relation("from_zone")
  connectionsTo      ZoneConnection[]        @relation("to_zone")
  discoveries        PlayerZoneDiscovery[]
  explorations       PlayerZoneExploration[]
  playersHere        Player[]                @relation("current_zone")
  playersBreadcrumb  Player[]                @relation("breadcrumb_zone")
  playersHome        Player[]                @relation("home_town")
  worldEvents        WorldEvent[]

  @@map("zones")
}

model ZoneConnection {
  id       String @id @default(uuid())
  fromId   String @map("from_zone_id")
  toId     String @map("to_zone_id")
  explorationThreshold Float @default(0) @map("exploration_threshold")

  fromZone Zone @relation("from_zone", fields: [fromId], references: [id], onDelete: Cascade)
  toZone   Zone @relation("to_zone", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@map("zone_connections")
}

model PlayerZoneDiscovery {
  id           String   @id @default(uuid())
  playerId     String   @map("player_id")
  zoneId       String   @map("zone_id")
  discoveredAt DateTime @default(now()) @map("discovered_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([playerId, zoneId])
  @@index([playerId])
  @@map("player_zone_discoveries")
}

model PlayerZoneExploration {
  id            String @id @default(cuid())
  playerId      String @map("player_id")
  zoneId        String @map("zone_id")
  turnsExplored Int    @default(0) @map("turns_explored")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([playerId, zoneId])
  @@index([playerId])
  @@map("player_zone_explorations")
}

// =============================================================================
// MOBS & COMBAT
// =============================================================================

model MobTemplate {
  id              String  @id @default(uuid())
  name            String  @db.VarChar(64)
  zoneId          String  @map("zone_id")
  level           Int     @default(1)
  hp              Int
  accuracy        Int
  defence         Int
  magicDefence    Int     @default(0) @map("magic_defence")
  evasion         Int
  damageMin       Int     @map("damage_min")
  damageMax       Int     @map("damage_max")
  xpReward        Int     @map("xp_reward")
  encounterWeight Int     @default(100) @map("encounter_weight")
  explorationTier Int     @default(1) @map("exploration_tier")
  spellPattern    Json    @default("[]") @map("spell_pattern")
  damageType      String  @default("physical") @map("damage_type")
  isBoss          Boolean @default(false) @map("is_boss")
  bossAoeDmg      Int?    @map("boss_aoe_dmg")
  bossBaseHp      Int?    @map("boss_base_hp")

  zone              Zone               @relation(fields: [zoneId], references: [id])
  dropTables        DropTable[]
  bestiary          PlayerBestiary[]
  bestiaryPrefixes  PlayerBestiaryPrefix[]
  familyMembers     MobFamilyMember[]
  bossEncounters    BossEncounter[]
  persistedMobs     PersistedMob[]

  @@map("mob_templates")
}

model DropTable {
  id             String  @id @default(uuid())
  mobTemplateId  String  @map("mob_template_id")
  itemTemplateId String  @map("item_template_id")
  dropChance     Decimal @map("drop_chance") @db.Decimal(5, 4)
  minQuantity    Int     @default(1) @map("min_quantity")
  maxQuantity    Int     @default(1) @map("max_quantity")

  mobTemplate  MobTemplate  @relation(fields: [mobTemplateId], references: [id], onDelete: Cascade)
  itemTemplate ItemTemplate @relation(fields: [itemTemplateId], references: [id], onDelete: Cascade)

  @@map("drop_tables")
}

// =============================================================================
// BESTIARY
// =============================================================================

model PlayerBestiary {
  playerId           String   @map("player_id")
  mobTemplateId      String   @map("mob_template_id")
  kills              Int      @default(0)
  firstEncounteredAt DateTime @default(now()) @map("first_encountered_at")

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  mobTemplate MobTemplate @relation(fields: [mobTemplateId], references: [id], onDelete: Cascade)

  @@id([playerId, mobTemplateId])
  @@map("player_bestiary")
}

model PlayerBestiaryPrefix {
  playerId      String   @map("player_id")
  mobTemplateId String   @map("mob_template_id")
  prefix        String   @db.VarChar(32)
  kills         Int      @default(0)
  firstSeenAt   DateTime @default(now()) @map("first_seen_at")

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  mobTemplate MobTemplate @relation(fields: [mobTemplateId], references: [id], onDelete: Cascade)

  @@id([playerId, mobTemplateId, prefix])
  @@map("player_bestiary_prefixes")
}

// =============================================================================
// RESOURCES & GATHERING
// =============================================================================

// Template defining what resource types can be found in a zone
model ResourceNode {
  id              String  @id @default(uuid())
  zoneId          String  @map("zone_id")
  resourceType    String  @map("resource_type") @db.VarChar(32)
  skillRequired   String  @map("skill_required") @db.VarChar(32)
  levelRequired   Int     @default(1) @map("level_required")
  baseYield       Int     @map("base_yield")
  discoveryChance Decimal @map("discovery_chance") @db.Decimal(5, 4)
  minCapacity     Int     @default(20) @map("min_capacity")
  maxCapacity     Int     @default(100) @map("max_capacity")
  discoveryWeight Int     @default(100) @map("discovery_weight")

  zone            Zone                 @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  playerNodes     PlayerResourceNode[]

  @@map("resource_nodes")
}

// Player's discovered resource node instance with remaining capacity
model PlayerResourceNode {
  id                String   @id @default(uuid())
  playerId          String   @map("player_id")
  resourceNodeId    String   @map("resource_node_id")
  remainingCapacity Int      @map("remaining_capacity")
  decayedCapacity   Int      @default(0) @map("decayed_capacity")
  discoveredAt      DateTime @default(now()) @map("discovered_at")

  player       Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  resourceNode ResourceNode @relation(fields: [resourceNodeId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@map("player_resource_nodes")
}

// =============================================================================
// CRAFTING
// =============================================================================

model CraftingRecipe {
  id               String @id @default(uuid())
  skillType        String @map("skill_type") @db.VarChar(32)
  requiredLevel    Int    @map("required_level")
  resultTemplateId String @map("result_template_id")
  isAdvanced       Boolean @default(false) @map("is_advanced")
  soulbound        Boolean @default(false)
  mobFamilyId      String? @map("mob_family_id")
  turnCost         Int    @map("turn_cost")
  materials        Json
  xpReward         Int    @map("xp_reward")

  resultTemplate ItemTemplate @relation(fields: [resultTemplateId], references: [id])
  mobFamily      MobFamily?   @relation(fields: [mobFamilyId], references: [id], onDelete: SetNull)
  learnedBy      PlayerRecipe[]

  @@index([isAdvanced])
  @@index([mobFamilyId])
  @@map("crafting_recipes")
}

// =============================================================================
// ACTIVITY LOGS
// =============================================================================

model ActivityLog {
  id           String   @id @default(uuid())
  playerId     String   @map("player_id")
  activityType String   @map("activity_type") @db.VarChar(32)
  turnsSpent   Int      @map("turns_spent")
  result       Json
  createdAt    DateTime @default(now()) @map("created_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  encounterSites EncounterSite[]

  @@index([playerId, createdAt])
  @@map("activity_logs")
}

model MobFamily {
  id             String @id @default(uuid())
  name           String @db.VarChar(64)
  siteNounSmall  String @map("site_noun_small") @db.VarChar(64)
  siteNounMedium String @map("site_noun_medium") @db.VarChar(64)
  siteNounLarge  String @map("site_noun_large") @db.VarChar(64)

  members        MobFamilyMember[]
  zoneMappings   ZoneMobFamily[]
  encounterSites EncounterSite[]
  advancedRecipes CraftingRecipe[]
  chestDropTables ChestDropTable[]

  @@map("mob_families")
}

model MobFamilyMember {
  mobFamilyId   String @map("mob_family_id")
  mobTemplateId String @map("mob_template_id")
  role          String @db.VarChar(16)

  mobFamily   MobFamily   @relation(fields: [mobFamilyId], references: [id], onDelete: Cascade)
  mobTemplate MobTemplate @relation(fields: [mobTemplateId], references: [id], onDelete: Cascade)

  @@id([mobFamilyId, mobTemplateId, role])
  @@index([mobTemplateId])
  @@map("mob_family_members")
}

model ZoneMobFamily {
  zoneId           String @map("zone_id")
  mobFamilyId      String @map("mob_family_id")
  discoveryWeight  Int    @default(100) @map("discovery_weight")
  minSize          String @map("min_size") @db.VarChar(16)
  maxSize          String @map("max_size") @db.VarChar(16)

  zone      Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  mobFamily MobFamily @relation(fields: [mobFamilyId], references: [id], onDelete: Cascade)

  @@id([zoneId, mobFamilyId])
  @@index([zoneId, discoveryWeight])
  @@map("zone_mob_families")
}

model EncounterSite {
  id          String   @id @default(uuid())
  playerId    String   @map("player_id")
  zoneId      String   @map("zone_id")
  mobFamilyId String   @map("mob_family_id")
  name        String   @db.VarChar(128)
  size        String   @db.VarChar(16)
  mobs        Json
  discoveredAt DateTime @default(now()) @map("discovered_at")
  sourceLogId String?  @map("source_log_id")

  clearStrategy    String?  @map("clear_strategy") @db.VarChar(16)
  currentRoom      Int      @default(1) @map("current_room")
  fullClearActive  Boolean  @default(true) @map("full_clear_active")
  roomCarryHp      Int?     @map("room_carry_hp")

  player    Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  zone      Zone       @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  mobFamily MobFamily  @relation(fields: [mobFamilyId], references: [id], onDelete: Cascade)
  sourceLog ActivityLog? @relation(fields: [sourceLogId], references: [id], onDelete: SetNull)

  @@index([playerId, discoveredAt])
  @@index([playerId, zoneId])
  @@map("encounter_sites")
}

model PlayerRecipe {
  playerId  String   @map("player_id")
  recipeId  String   @map("recipe_id")
  learnedAt DateTime @default(now()) @map("learned_at")

  player Player         @relation(fields: [playerId], references: [id], onDelete: Cascade)
  recipe CraftingRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@id([playerId, recipeId])
  @@index([recipeId])
  @@map("player_recipes")
}

model ChestDropTable {
  id             String  @id @default(uuid())
  mobFamilyId    String  @map("mob_family_id")
  chestRarity    String  @map("chest_rarity") @db.VarChar(16)
  itemTemplateId String  @map("item_template_id")
  dropChance     Decimal @map("drop_chance") @db.Decimal(5, 4)
  minQuantity    Int     @default(1) @map("min_quantity")
  maxQuantity    Int     @default(1) @map("max_quantity")

  mobFamily    MobFamily    @relation(fields: [mobFamilyId], references: [id], onDelete: Cascade)
  itemTemplate ItemTemplate @relation(fields: [itemTemplateId], references: [id], onDelete: Cascade)

  @@index([mobFamilyId, chestRarity])
  @@map("chest_drop_tables")
}

// =============================================================================
// CHAT
// =============================================================================

model ChatMessage {
  id          String   @id @default(uuid())
  channelType String   @map("channel_type") @db.VarChar(16)
  channelId   String   @map("channel_id") @db.VarChar(64)
  playerId    String   @map("player_id")
  username    String   @db.VarChar(32)
  message     String   @db.VarChar(200)
  messageType String   @default("player") @map("message_type") @db.VarChar(8)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([channelType, channelId, createdAt])
  @@map("chat_messages")
}

// =============================================================================
// PVP ARENA
// =============================================================================

model PvpRating {
  id           String    @id @default(uuid())
  playerId     String    @unique @map("player_id")
  player       Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  rating       Int       @default(1000)
  wins         Int       @default(0)
  losses       Int       @default(0)
  draws        Int       @default(0)
  winStreak    Int       @default(0) @map("win_streak")
  bestWinStreak Int      @default(0) @map("best_win_streak")
  bestRating   Int       @default(1000) @map("best_rating")
  lastFoughtAt DateTime? @map("last_fought_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("pvp_ratings")
}

model PvpMatch {
  id                   String   @id @default(uuid())
  attackerId           String   @map("attacker_id")
  attacker             Player   @relation("PvpAttacker", fields: [attackerId], references: [id])
  defenderId           String   @map("defender_id")
  defender             Player   @relation("PvpDefender", fields: [defenderId], references: [id])
  attackerRating       Int      @map("attacker_rating")
  defenderRating       Int      @map("defender_rating")
  attackerRatingChange Int      @map("attacker_rating_change")
  defenderRatingChange Int      @map("defender_rating_change")
  winnerId             String?  @map("winner_id")
  combatLog            Json     @map("combat_log")
  attackerStyle        String   @map("attacker_style") @db.VarChar(16)
  defenderStyle        String   @map("defender_style") @db.VarChar(16)
  turnsSpent           Int      @map("turns_spent")
  isRevenge            Boolean  @default(false) @map("is_revenge")
  attackerRead         Boolean  @default(true) @map("attacker_read")
  defenderRead         Boolean  @default(false) @map("defender_read")
  createdAt            DateTime @default(now()) @map("created_at")

  @@index([attackerId, createdAt])
  @@index([defenderId, createdAt])
  @@map("pvp_matches")
}

model PvpCooldown {
  id         String   @id @default(uuid())
  attackerId String   @map("attacker_id")
  defenderId String   @map("defender_id")
  expiresAt  DateTime @map("expires_at")

  @@unique([attackerId, defenderId])
  @@map("pvp_cooldowns")
}

// =============================================================================
// WORLD EVENTS
// =============================================================================

model WorldEvent {
  id             String   @id @default(uuid())
  type           String   @db.VarChar(16)
  zoneId         String?  @map("zone_id")
  title          String   @db.VarChar(128)
  description    String   @db.Text
  effectType     String   @map("effect_type") @db.VarChar(32)
  effectValue    Float    @map("effect_value")
  targetMobId    String?  @map("target_mob_id")
  targetFamily   String?  @map("target_family")
  targetResource String?  @map("target_resource") @db.VarChar(64)
  startedAt      DateTime @default(now()) @map("started_at")
  expiresAt      DateTime? @map("expires_at")
  status         String   @default("active") @db.VarChar(16)
  createdBy      String   @default("system") @map("created_by") @db.VarChar(32)

  zone           Zone?           @relation(fields: [zoneId], references: [id])
  bossEncounter  BossEncounter?

  @@index([status, type])
  @@index([zoneId, status])
  @@map("world_events")
}

model BossEncounter {
  id             String    @id @default(uuid())
  eventId        String    @unique @map("event_id")
  mobTemplateId  String    @map("mob_template_id")
  currentHp      Int       @map("current_hp")
  maxHp          Int       @map("max_hp")
  baseHp         Int       @map("base_hp")
  raidPoolHp     Int?      @map("raid_pool_hp")
  raidPoolMax    Int?      @map("raid_pool_max")
  scaledAt       DateTime? @map("scaled_at")
  roundNumber    Int       @default(0) @map("round_number")
  nextRoundAt    DateTime? @map("next_round_at")
  status         String    @default("waiting") @db.VarChar(16)
  killedBy       String?   @map("killed_by")
  roundSummaries Json?     @map("round_summaries")
  rewardsByPlayer Json?    @map("rewards_by_player")

  event         WorldEvent        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  mobTemplate   MobTemplate       @relation(fields: [mobTemplateId], references: [id])
  participants  BossParticipant[]

  @@index([status, nextRoundAt])
  @@map("boss_encounters")
}

model BossParticipant {
  id              String @id @default(uuid())
  encounterId     String @map("encounter_id")
  playerId        String @map("player_id")
  role            String @db.VarChar(16)
  roundNumber     Int    @map("round_number")
  turnsCommitted  Int    @map("turns_committed")
  totalDamage     Int    @default(0) @map("total_damage")
  totalHealing    Int    @default(0) @map("total_healing")
  attacks         Int    @default(0)
  hits            Int    @default(0)
  crits           Int    @default(0)
  autoSignUp      Boolean @default(false) @map("auto_sign_up")
  currentHp       Int    @map("current_hp")
  status          String @default("alive") @db.VarChar(16)

  encounter BossEncounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  player    Player        @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([encounterId, playerId, roundNumber])
  @@index([encounterId, roundNumber])
  @@map("boss_participants")
}

model PersistedMob {
  id            String   @id @default(uuid())
  playerId      String   @map("player_id")
  mobTemplateId String   @map("mob_template_id")
  zoneId        String   @map("zone_id")
  currentHp     Int      @map("current_hp")
  maxHp         Int      @map("max_hp")
  damagedAt     DateTime @default(now()) @map("damaged_at")

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  mobTemplate MobTemplate @relation(fields: [mobTemplateId], references: [id], onDelete: Cascade)

  @@index([playerId, zoneId])
  @@map("persisted_mobs")
}

// =============================================================================
// ACHIEVEMENTS
// =============================================================================

model PlayerStats {
  playerId                String   @id @map("player_id")
  totalCrafts             Int      @default(0) @map("total_crafts")
  totalRaresCrafted       Int      @default(0) @map("total_rares_crafted")
  totalEpicsCrafted       Int      @default(0) @map("total_epics_crafted")
  totalLegendariesCrafted Int      @default(0) @map("total_legendaries_crafted")
  totalSalvages           Int      @default(0) @map("total_salvages")
  totalForgeUpgrades      Int      @default(0) @map("total_forge_upgrades")
  totalGatheringActions   Int      @default(0) @map("total_gathering_actions")
  totalTurnsSpent         Int      @default(0) @map("total_turns_spent")
  totalDeaths             Int      @default(0) @map("total_deaths")
  updatedAt               DateTime @updatedAt @map("updated_at")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("player_stats")
}

model PlayerAchievement {
  playerId      String   @map("player_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  rewardClaimed Boolean  @default(false) @map("reward_claimed")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@id([playerId, achievementId])
  @@map("player_achievements")
}
